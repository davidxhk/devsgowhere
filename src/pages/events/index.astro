---
import BaseHead from "../../components/BaseHead.astro";
import Header from "../../components/Header.astro";
import Theme from "../../layouts/Theme.astro";
import Footer from "../../components/Footer.astro";

import { SITE_TITLE, SITE_DESCRIPTION } from "../../consts";
import { getCollection } from "astro:content";
import { Image } from "astro:assets";
import FormattedEventDate from "../../components/FormattedEventDate.astro";

const orgs = await getCollection("orgs");

const now = new Date();
const events = (await getCollection("events"))
  .filter((event) => {
    const startDate = new Date(event.data.startDate);
    return startDate >= now;
  })
  .sort((a, b) => a.data.startDate.valueOf() - b.data.startDate.valueOf());
---

<!doctype html>
<html lang="en">
  <head>
    <BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
  </head>
  <Theme>
    <Header />
    <main class="events-list-page pt-xl pb-3xl">
      <h1 class="text-3xl text-bold text-accent mb-xl">
        Upcoming Events
      </h1>      
      <div class="container">
        <section>
              <div class="event-search form-control">
                <i class="form-control__prepend fa fa-search"></i>
                <input
                  id="event-search__input"
                  type="text"
                  class="form-control__input"
                  placeholder="Search events by name, tags, organizer..."
                />
                <button id="event-search__clear" class="form-control__append" style="display: none;">
                  <i class="fa fa-times"></i>
                </button>
              </div>
              <div class="search-results-info mb-m" style="display: none;">
                <p>Showing <span id="results-count">0</span> results</p>
              </div>
          <ul class="event-list">
            {
              events.map((event) => (
                <li class="event-list-item" data-id={event.id}>
                  <a class="card" href={`/events/${event.id}/`}>
                    <Image
                      width={720}
                      height={360}
                      src={event.data.heroImage}
                      alt=""
                    />
                    <div class="event-list-item__info">
                    <div class="org-name text-s text-gray-5 mb-2xs">
                        {
                          orgs.find((org) => org.id === event.data.org.id)?.data
                            .title
                        }
                      </div>
                      <div class="event-title text-accent text-3xl text-bold mb-l">{event.data.title}</div>
                      <div class="event-date mb-xs text-bold">
                        <i class="fa fa-calendar-days mr-xs"></i>
                        <FormattedEventDate
                          startDate={event.data.startDate}
                          startTime={event.data.startTime}
                          endDate={event.data.endDate}
                          endTime={event.data.endTime}
                        />
                      </div>
                      <div class="event-location mb-0">
                        <div style="display: flex; align-items: baseline;">
                        <i class="fa fa-location-dot mr-xs"></i>
                        <div style="display: flex; flex-direction: column; align-items: flex-start;">
                        <p class="ml-xs mt-0 mb-0 text-bold">{event.data.venue}</p>
                        <p class="text-capitalise ml-xs mt-0">{(event.data.venueAddress ?? '').toLowerCase()}</p>
                        </div>
                        </div>
                      </div>
                      <div class="event-description mb-m">{event.data.description.slice(0, 200)}...</div>                      
                        <ul class="tag-list mb-0">
                        { event.data.tags?.slice(0,5).map((tag)=>{
                          return (
                            <li class="tag">
                              #{tag}
                            </li>
                          )
                        }) }
                      </ul>
                    </div>                    
                  </a>
                </li>
              ))
            }
          </ul>        
          <div class="event-list__empty" style="display: none;">
            <p class="text-gray-5 text-2xl">No results found ðŸ¤•</p>
          </div>
      </div>
    </main>
    <Footer />
  </Theme>
  <script>
    // Fetch search index
    const events = [];
    fetch('/events/search-index.json')
      .then(response => response.json())
      .then(data => events.push(...data))
      .catch(error => console.error('Error fetching search index:', error));

    // DOM elements
    const searchInput = document.querySelector('#event-search__input');
    const clearButton = document.querySelector('#event-search__clear');
    const emptyState = document.querySelector('.event-list__empty');
    const resultsInfo = document.querySelector('.search-results-info');
    const resultsCount = document.querySelector('#results-count');
    const eventItems = document.querySelectorAll('.event-list-item');

    // Normalize text by removing dashes, underscores and spaces
    const normalize = (text) => text?.toLowerCase().replace(/[-_\s]/g, '') || '';

    // Debounce function for search optimization
    const debounce = (fn, delay = 300) => {
      let timer;
      return (...args) => {
        clearTimeout(timer);
        timer = setTimeout(() => fn(...args), delay);
      };
    };

    // Search implementation
    const performSearch = () => {
      const query = searchInput.value.toLowerCase().trim();
      const normalizedQuery = normalize(query);
      
      // Toggle clear button visibility
      clearButton.style.display = query ? 'block' : 'none';
      
      // If empty query, show all events
      if (!query) {
        emptyState.style.display = 'none';
        resultsInfo.style.display = 'none';
        eventItems.forEach(item => item.classList.remove('hide'));
        return;
      }

      // Filter events
      const matches = events.filter(event => {
        // Try exact matches first (for better performance)
        if (event.title?.toLowerCase().includes(query) || 
            event.org?.title?.toLowerCase().includes(query) ||
            event.venue?.toLowerCase().includes(query)) {
          return true;
        }
        
        // Try normalized matches for more flexible searching
        if (normalize(event.title).includes(normalizedQuery)) return true;
        if (normalize(event.org?.title).includes(normalizedQuery)) return true;
        if (normalize(event.venue).includes(normalizedQuery)) return true;
        if (normalize(event.description).includes(normalizedQuery)) return true;
        
        // Enhanced tag search - check individual tags and concatenated tags
        if (event.tags?.length) {
          // Check individual tags
          if (event.tags.some(tag => normalize(tag).includes(normalizedQuery))) {
            return true;
          }
          
          // Create concatenated versions of tags for more flexible matching
          const normalizedTags = event.tags.map(tag => normalize(tag));
          const concatenatedTags = normalizedTags.join('');
          
          // Check if the query is within the concatenated tags
          if (concatenatedTags.includes(normalizedQuery)) {
            return true;
          }
          
          // Try different permutations for multi-word searches
          // This helps match "javascriptworkshop" even if tags are ["workshop", "javascript"]
          if (normalizedQuery.length > 5) {
            for (let i = 3; i < normalizedQuery.length - 2; i++) {
              const firstPart = normalizedQuery.substring(0, i);
              const secondPart = normalizedQuery.substring(i);
              
              if (normalizedTags.some(tag => tag.includes(firstPart)) && 
                  normalizedTags.some(tag => tag.includes(secondPart))) {
                return true;
              }
            }
          }
        }
        
        return false;
      });

      // Update UI based on results
      resultsCount.textContent = matches.length;
      resultsInfo.style.display = 'block';
      emptyState.style.display = matches.length ? 'none' : 'block';
      
      // Show/hide matching events
      eventItems.forEach(item => {
        const eventId = item.getAttribute('data-id');
        const visible = matches.some(event => event.id === eventId);
        item.classList.toggle('hide', !visible);
      });
    };

    // Set up event listeners
    searchInput.addEventListener('input', debounce(performSearch));
    clearButton.addEventListener('click', () => {
      searchInput.value = '';
      performSearch();
      searchInput.focus();
    });
  </script>
</html>

<style lang="scss">
  .events-list-page {
    text-align: center;
  }

  ul.event-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  li.event-list-item a {

    $width: 720px;

    //------------------------------------------------------------

    // size
    max-width: $width;
    margin-top: 1rem;
    margin-bottom: 1rem;
    
    // layout
    display: inline-block;
  
    // color
    color: inherit;
    &:visited{
      color: inherit;
    }

    // text
    text-decoration: none;

    // image
    img {
      max-width: 100%;
      width: 720px;
      height: auto;
    }

    // event info block
    .event-list-item__info {
      padding: 2rem;
      text-align: left;
    }

    &:hover .event-title {
      text-decoration: underline;
      text-decoration-thickness: 2px;
    }

  }

  .form-control__append {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: #999;
    cursor: pointer;
    padding: 5px;
    
    &:hover {
      color: #666;
    }
  }
  
  .event-list-item {
    transition: opacity 0.3s ease-out, height 0.5s ease-out;
    opacity: 1;
    height: auto;
    overflow: hidden;
    
    &.hide {
      opacity: 0;
      height: 0;
      margin: 0;
      padding: 0;
    }
  }
  
  .hide {
    display: none;
  }
  
  .search-results-info {
    text-align: center;
    color: #666;
    font-size: 0.9rem;
    margin-top: 1rem;
  }
  
  .event-list__empty {
    text-align: center;
    margin: 3rem 0;
  }
</style>
